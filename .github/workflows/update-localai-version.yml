name: Update LocalAI Version

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch latest LocalAI release tag
        id: latest
        run: |
          tag=$(python - <<'PY'
          import json
          import urllib.request

          url = "https://api.github.com/repos/mudler/LocalAI/releases/latest"
          with urllib.request.urlopen(url) as resp:
              data = json.load(resp)

          print(data["tag_name"])
          PY
          )
          if [ -z "$tag" ]; then
            echo "Failed to fetch latest release tag" >&2
            exit 1
          fi
          version=${tag#v}
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Read current LocalAI version
        id: current
        run: |
          version=$(grep -E '^ARG LOCALAI_VERSION=' Dockerfile | cut -d= -f2)
          if [ -z "$version" ]; then
            echo "LOCALAI_VERSION not found in Dockerfile" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Update Dockerfile version
        if: steps.latest.outputs.version != steps.current.outputs.version
        run: |
          sed -i "s/^ARG LOCALAI_VERSION=.*/ARG LOCALAI_VERSION=${{ steps.latest.outputs.version }}/" Dockerfile

      - name: Commit and push
        if: steps.latest.outputs.version != steps.current.outputs.version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Dockerfile
          git commit -m "chore: bump LocalAI to v${{ steps.latest.outputs.version }}"
          git push
